# Deploy to Homologation (Locaweb FTP) — BidExpert
# Triggered on push to homolog branch
# Includes DB migrations and seeds

# ⚠️ OBSOLETO: Deploy Locaweb FTP para HML — Substituído por Vercel
# Mantido desabilitado para referência histórica. NÃO reativar.
name: '[DISABLED] Deploy Homologation (Locaweb)'

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'ATENÇÃO: Este workflow é OBSOLETO. HML agora é via Vercel (demo-stable branch).'
        required: true
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    name: Build and Deploy to Locaweb
    runs-on: ubuntu-latest
    environment: Homologation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install --ignore-scripts --no-package-lock

      - name: Generate Prisma Client
        run: npx prisma generate

      #- name: Reset DB (HML) - Temporary Fix for Schema Drift
      #  run: npx prisma db push --force-reset
      #  continue-on-error: true
      #  env:
      #    DATABASE_URL: ${{ secrets.DATABASE_URL_HML }}

      #- name: Run DB Seeds (HML)
      #  run: npx prisma db seed
      #  continue-on-error: true
      #  env:
      #    DATABASE_URL: ${{ secrets.DATABASE_URL_HML }}

      - name: Build Application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_HML }}
          NEXT_PUBLIC_ACTIVE_DATABASE_SYSTEM: "mysql"
          SESSION_SECRET: ${{ secrets.SESSION_SECRET_HML || secrets.SESSION_SECRET || 'ci-test-secret-key-32-chars-long!' }}

      - name: Prepare Deploy Package (ZIP for speed)
        run: |
          mkdir -p deploy_dist
          cp -r .next/standalone/. deploy_dist/
          cp -r .next/static deploy_dist/.next/static
          cp -r public deploy_dist/public
          
          # Locaweb Passenger Compatibility: Rename server.js to app.js
          mv deploy_dist/server.js deploy_dist/app.js
          
          # Create .htaccess for Passenger
          cat <<EOF > deploy_dist/.htaccess
          # Locaweb Passenger Node.js Configuration
          PassengerEnabled on
          PassengerAppType node
          PassengerAppRoot /home/bidexpert3/public_html
          PassengerStartupFile app.js
          
          # Optional: Redirect to HTTPS
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          EOF

          # List contents to verify
          ls -R deploy_dist | head -n 20

          # Tar everything to avoid slow FTP of 10k+ files
          cd deploy_dist && tar -czf ../deploy.tar.gz .

      - name: FTP Deploy compressed package
        uses: locaweb/ftp-deploy@1.0.0
        with:
          host: ${{ secrets.HOST }} 
          user: ${{ secrets.USER }}
          password: ${{ secrets.PASS }}
          localDir: "."
          remoteDir: "/home/bidexpert3/"
          forceSsl: false
          exclude: |
            **/*
            !deploy.tar.gz

      - name: Atomic Unpack and Swap via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASS }}
          port: 22
          script: |
            # Mover para o diretório base
            cd /home/bidexpert3/
            
            # Garantir que o tar.gz existe
            if [ ! -f "deploy.tar.gz" ]; then
              echo "ERRO: deploy.tar.gz não encontrado após FTP!"
              exit 1
            fi

            # Extração atômica em staging
            rm -rf public_html_staging
            mkdir -p public_html_staging
            echo "Extraindo arquivos..."
            tar -xzf deploy.tar.gz -C public_html_staging/
            rm deploy.tar.gz

            # Backup da versão atual
            if [ -d "public_html" ]; then
              echo "Criando backup da versão atual..."
              rm -rf public_html_old
              mv public_html public_html_old
            fi

            # Swap staging para produção
            echo "Realizando swap (staging -> production)..."
            mv public_html_staging public_html

            # Reiniciar Passenger Node.js
            echo "Reiniciando a aplicação..."
            mkdir -p public_html/tmp
            touch public_html/tmp/restart.txt
            
            echo "Deploy concluído com sucesso!"
              mv public_html public_html_backup_prev
            fi
            
            mv public_html_staging public_html
            cd public_html
            
            # Restart via Passenger
            mkdir -p tmp
            touch tmp/restart.txt
            echo "Deploy concluído com sucesso."
