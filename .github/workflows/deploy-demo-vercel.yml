# ==============================================================================
# GitHub Action: Deploy DEMO para Vercel
# ==============================================================================
# Trigger: Push na branch demo-stable
# AÃ§Ã£o: Deploy para Vercel com Prisma Postgres
# ==============================================================================

name: Deploy DEMO to Vercel

on:
  push:
    branches:
      - demo-stable
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'demo'
        type: choice
        options:
          - demo
          - preview

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  PRISMA_SCHEMA: prisma/schema.postgresql.prisma

jobs:
  # ============================================================================
  # JOB 1: Build & Type Check
  # ============================================================================
  build:
    name: ğŸ”¨ Build & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ”„ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma
        
      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate
        
      - name: ğŸ” Type Check
        run: npm run typecheck
        
      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DEMO_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.DEMO_NEXTAUTH_SECRET }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.DEMO_APP_URL }}

  # ============================================================================
  # JOB 2: Deploy to Vercel
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build
    
    environment:
      name: demo
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install Vercel CLI
        run: npm install -g vercel@latest
        
      - name: ğŸ”„ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma
        
      - name: ğŸ”— Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: ğŸ—ï¸ Build with Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: ğŸš€ Deploy to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: $url"

  # ============================================================================
  # JOB 3: Database Migration (opcional - apenas se houver mudanÃ§as)
  # ============================================================================
  migrate:
    name: ğŸ—ƒï¸ Database Migration
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[migrate]')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ”„ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma
        
      - name: ğŸ—ƒï¸ Run Prisma Migrate
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DEMO_DATABASE_URL_DIRECT }}

  # ============================================================================
  # JOB 4: Smoke Test (E2E bÃ¡sico)
  # ============================================================================
  smoke-test:
    name: ğŸ§ª Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ§ª Run Smoke Tests
        run: npx playwright test tests/e2e/vercel-smoke.spec.ts --project=chromium
        env:
          PLAYWRIGHT_BASE_URL: ${{ secrets.DEMO_APP_URL }}
          
      - name: ğŸ“Š Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # JOB 5: Notify (Slack/Discord - opcional)
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy, smoke-test]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify on Success
        if: ${{ needs.deploy.result == 'success' && needs.smoke-test.result == 'success' }}
        run: |
          echo "âœ… Deploy DEMO successful!"
          echo "URL: ${{ needs.deploy.outputs.url }}"
          
      - name: ğŸš¨ Notify on Failure
        if: ${{ needs.deploy.result == 'failure' || needs.smoke-test.result == 'failure' }}
        run: |
          echo "âŒ Deploy DEMO failed!"
          echo "Check the workflow logs for details."
