# ==============================================================================
# GitHub Action: Branch Protection & CI Gates
# ==============================================================================
# ValidaÃ§Ã£o de cÃ³digo em todos os PRs
# Bloqueia merge em main sem CI verde
# ==============================================================================

name: CI - Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - demo-stable
  push:
    branches:
      - main
      - demo-stable

env:
  PRISMA_SCHEMA: prisma/schema.postgresql.prisma

jobs:
  # ============================================================================
  # JOB 1: Type Check & Lint
  # ============================================================================
  typecheck:
    name: ğŸ” Type Check & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ï¿½ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma

      - name: ï¿½ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate
        
      - name: ğŸ” Type Check
        run: npm run typecheck
        
      - name: ğŸ§¹ Lint
        run: npm run lint

  # ============================================================================
  # JOB 2: Build Test
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”„ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma
        
      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          # Dummy values for build (nÃ£o acessa DB)
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          NEXTAUTH_SECRET: "dummy-secret-for-build-only"
          AUTH_SECRET: "dummy-secret-for-build-only"
          SESSION_SECRET: "ci-session-secret-key-at-least-32-chars-long!"

  # ============================================================================
  # JOB 3: Unit Tests (Vitest)
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”„ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma
        
      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ§ª Run Unit Tests
        run: xvfb-run -a npm run test:unit

  # ============================================================================
  # JOB 4: Schema Validation (MySQL + PostgreSQL)
  # ============================================================================
  schema-validation:
    name: ğŸ—ƒï¸ Schema Validation
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy"
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ” Validate MySQL Schema
        run: npx prisma validate --schema=prisma/schema.prisma
        env:
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy"
        
      - name: ğŸ” Validate PostgreSQL Schema
        run: |
          if [ -f "prisma/schema.postgresql.prisma" ]; then
            npx prisma validate --schema=prisma/schema.postgresql.prisma
          else
            echo "âš ï¸ PostgreSQL schema not found, skipping"
          fi
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

  # ============================================================================
  # JOB 5: Security Audit
  # ============================================================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ”’ npm audit
        run: npm audit --audit-level=critical

  # ============================================================================
  # RESULTADO: Gate de Qualidade
  # ============================================================================
  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [typecheck, build, schema-validation]
    if: always()
    
    steps:
      - name: âœ… Check All Jobs
        run: |
          if [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.schema-validation.result }}" != "success" ]; then
            echo "âŒ Quality gate failed!"
            exit 1
          fi
          echo "âœ… All quality checks passed!"
