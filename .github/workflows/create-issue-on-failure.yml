name: Create Issue on CI/CD Failure

# Trigger when any of these workflows complete
on:
  workflow_run:
    workflows: 
      - "CI - Pull Request Checks"
      - "Deploy DEMO to Vercel"
      - "P0 CI Pipeline"
      - "Deploy to Demo (Vercel)"
      - "Deploy to HML (Vercel)"
      - "Deploy to Production"
      - "Seed Verification"
    types: 
      - completed

permissions:
  contents: read
  issues: write
  actions: write

jobs:
  create-failure-issue:
    name: Create Issue for Failed Workflow
    runs-on: ubuntu-latest
    # Only run if the workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Get workflow run details
        id: workflow_details
        uses: actions/github-script@v7
        with:
          script: |
            // Get detailed information about the failed workflow
            const runId = context.payload.workflow_run.id;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get the workflow run
            const { data: workflowRun } = await github.rest.actions.getWorkflowRun({
              owner,
              repo,
              run_id: runId,
            });
            
            // Get the jobs for this run
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner,
              repo,
              run_id: runId,
            });
            
            // Find failed jobs
            const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');
            
            return {
              workflowName: workflowRun.name,
              runNumber: workflowRun.run_number,
              runId: workflowRun.id,
              branch: workflowRun.head_branch,
              commit: workflowRun.head_sha.substring(0, 7),
              commitMessage: workflowRun.head_commit.message.split('\n')[0],
              actor: workflowRun.triggering_actor.login,
              createdAt: workflowRun.created_at,
              htmlUrl: workflowRun.html_url,
              failedJobs: failedJobs.map(job => ({
                name: job.name,
                conclusion: job.conclusion,
                htmlUrl: job.html_url
              }))
            };

      - name: Collect failure logs
        id: collect_logs
        run: |
          # Install GitHub CLI if not available
          which gh || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
            sudo apt update && sudo apt install gh -y)
          
          # Collect logs from the failed run (limit to 5000 chars to avoid too large issues)
          echo "Collecting logs for run ${{ github.event.workflow_run.id }}..."
          LOGS=$(gh run view ${{ github.event.workflow_run.id }} --log-failed 2>&1 || echo "Failed to collect logs")
          
          # Limit log size
          LOGS_TRUNCATED=$(echo "$LOGS" | head -c 5000)
          
          # Save to file for multiline handling
          echo "$LOGS_TRUNCATED" > /tmp/workflow_logs.txt
          
          # Check if logs were truncated
          if [ ${#LOGS} -gt 5000 ]; then
            echo "" >> /tmp/workflow_logs.txt
            echo "... (logs truncated, see full logs at workflow URL)" >> /tmp/workflow_logs.txt
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const details = ${{ steps.workflow_details.outputs.result }};
            
            // Read logs from file
            let logs = 'No logs available';
            try {
              logs = fs.readFileSync('/tmp/workflow_logs.txt', 'utf8');
            } catch (error) {
              logs = `Error reading logs: ${error.message}`;
            }
            
            // Format failed jobs list
            const failedJobsList = details.failedJobs.map(job => 
              `- [${job.name}](${job.htmlUrl}) - ${job.conclusion}`
            ).join('\n');
            
            // Create issue body
            const issueBody = `## üö® CI/CD Falha Detectada Automaticamente

            O workflow **${details.workflowName}** falhou e requer aten√ß√£o.

            ### üìä Informa√ß√µes do Workflow

            | Campo | Valor |
            |-------|-------|
            | **Workflow** | [${details.workflowName} #${details.runNumber}](${details.htmlUrl}) |
            | **Branch** | \`${details.branch}\` |
            | **Commit** | \`${details.commit}\` - ${details.commitMessage} |
            | **Executado por** | @${details.actor} |
            | **Data/Hora** | ${details.createdAt} |
            | **Run ID** | ${details.runId} |

            ### ‚ùå Jobs Falhados

            ${failedJobsList || 'Nenhum job espec√≠fico identificado'}

            ### üìã Logs da Falha

            <details>
            <summary>Clique para expandir os logs</summary>

            \`\`\`
            ${logs}
            \`\`\`

            </details>

            ### üîß Pr√≥ximas A√ß√µes

            1. **An√°lise Autom√°tica**: O AI Agent ser√° acionado automaticamente para investigar
            2. **Tentativas de Corre√ß√£o**: At√© 3 tentativas autom√°ticas ser√£o realizadas
            3. **Escala√ß√£o**: Se n√£o for resolvido, ser√° escalado para revis√£o humana

            ### üè∑Ô∏è Labels Aplicadas

            - \`ai-fix\`: Issue ser√° processada pelo AI Agent automaticamente
            - \`ci-cd\`: Problema relacionado a pipeline CI/CD
            - \`priority:high\`: Alta prioridade (falha em workflow cr√≠tico)
            - \`automated\`: Issue criada automaticamente pelo sistema

            ---

            *Esta issue foi criada automaticamente pelo sistema de monitoramento CI/CD.*`;

            // Create the issue
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® CI/CD Failure: ${details.workflowName} - Run #${details.runNumber}`,
              body: issueBody + '\n\n@copilot por favor analise e corrija esta falha.',
              labels: ['ai-fix', 'ci-cd', 'priority:high', 'automated']
            });

            // Assign Copilot (best effort, should not block automation)
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: ['Copilot']
              });
            } catch (error) {
              console.log(`Could not assign @copilot automatically: ${error.message}`);
            }
            
            console.log(`Issue created: ${issue.html_url}`);
            return issue.number;

      - name: Trigger AI auto-fix workflow
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(${{ steps.create_issue.outputs.result }});

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ai-agent-auto-fix.yml',
              ref: context.payload.workflow_run.head_branch,
              inputs: {
                issue_number: String(issueNumber)
              }
            });

            console.log(`AI auto-fix workflow dispatched for issue #${issueNumber}`);

      - name: Add initial comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create_issue.outputs.result }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **AI Agent ser√° acionado automaticamente**

              O sistema de corre√ß√£o autom√°tica foi notificado desta falha e iniciar√° a an√°lise em breve.
              
              Voc√™ pode acompanhar o progresso aqui nesta issue. Se a corre√ß√£o autom√°tica n√£o for bem-sucedida ap√≥s 3 tentativas, a issue ser√° escalada para revis√£o humana.`
            });

      - name: Generate workflow summary
        run: |
          echo "## üö® CI/CD Failure Issue Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A failure was detected in workflow **${{ github.event.workflow_run.name }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue Number**: #${{ steps.create_issue.outputs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The AI Agent auto-fix workflow was dispatched automatically for this issue." >> $GITHUB_STEP_SUMMARY
