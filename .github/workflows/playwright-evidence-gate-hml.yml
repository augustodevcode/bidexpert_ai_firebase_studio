# ==============================================================================
# GitHub Action: Playwright Evidence Gate para PRs ‚Üí HML
# ==============================================================================
# REGRA: Todo PR para hml DEVE ter evid√™ncia visual dos testes Playwright.
# Este workflow:
#   1. Executa testes da Biblioteca de M√≠dia (ML-01 a ML-08) contra Vercel HML
#   2. Faz upload dos screenshots como artefato (evid√™ncia obrigat√≥ria)
#   3. Comenta no PR com link para o relat√≥rio
#   4. Bloqueia o PR se nenhum teste passar (falha com exit code != 0)
#
# O status check "playwright-evidence" deve estar configurado como required
# nas branch protection rules de `hml`.
# ==============================================================================

name: üé≠ Playwright Evidence Gate (HML)

on:
  pull_request:
    branches:
      - hml
    types: [opened, synchronize, reopened]

jobs:
  playwright-evidence:
    name: üé≠ Playwright Evidence ‚Äî Biblioteca de M√≠dia
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üé≠ Install Playwright browsers (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: üîÑ Copy PostgreSQL schema
        run: cp prisma/schema.postgresql.prisma prisma/schema.prisma

      - name: üóÑÔ∏è Generate Prisma Client
        run: npx prisma generate

      - name: üß™ Executar testes de Biblioteca de M√≠dia (HML)
        id: playwright_run
        run: |
          npx playwright test \
            --config=playwright.media-vercel.config.ts \
            --reporter=list,html,json \
            2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        env:
          PLAYWRIGHT_BASE_URL: ${{ secrets.HML_APP_URL }}
          CI: true
        continue-on-error: true  # N√£o falhar aqui; falhar no step de gate abaixo

      - name: üìä Upload screenshots (evid√™ncia obrigat√≥ria para PR)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-evidence-hml-pr${{ github.event.pull_request.number }}
          path: |
            test-results/media-mcp/
            playwright-report-media-vercel/
          retention-days: 30  # Reten√ß√£o longa para evid√™ncia de compliance

      - name: üìã Upload relat√≥rio HTML completo
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-hml-pr${{ github.event.pull_request.number }}
          path: playwright-report-media-vercel/
          retention-days: 30

      - name: üí¨ Comentar no PR com resultado dos testes
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const exitCode = '${{ steps.playwright_run.outputs.exit_code }}';
            const status = exitCode === '0' ? '‚úÖ PASSOU' : '‚ùå FALHOU';
            const emoji = exitCode === '0' ? 'üü¢' : 'üî¥';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = `${runUrl}#artifacts`;

            const body = `## ${emoji} Playwright Evidence Gate ‚Äî Biblioteca de M√≠dia

            | Teste | Status |
            |-------|--------|
            | ML-01 Galeria renderiza | ${status} |
            | ML-02 Upload aparece na galeria | ${status} |
            | ML-03 Busca/filtro | ${status} |
            | ML-04 Sidebar metadados | ${status} |
            | ML-05 Lightbox preview | ${status} |
            | ML-06 Editor de imagem | ${status} |
            | ML-07 Delete remove da galeria | ${status} |
            | ML-08 URL da imagem acess√≠vel | ${status} |

            **üì∏ Evid√™ncias visuais (screenshots):** [Ver artefatos](${artifactUrl})
            **üìä Relat√≥rio completo:** [Ver run](${runUrl})

            > ‚ö†Ô∏è Este PR ${exitCode === '0' ? 'passou' : 'N√ÉO PASSOU'} na gate de evid√™ncias Playwright obrigat√≥ria para merge em \`hml\`.
            > Conforme regra: _Todo PR para hml DEVE ter evid√™ncias visuais dos testes Playwright._
            `;

            // Verificar se j√° existe coment√°rio do bot neste PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Playwright Evidence Gate')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            }

      - name: üö¶ Gate Final ‚Äî Falhar se testes n√£o passaram
        if: steps.playwright_run.outputs.exit_code != '0'
        run: |
          echo "‚ùå Playwright Evidence Gate FALHOU!"
          echo ""
          echo "Este PR n√£o pode ser mergeado em 'hml' sem evid√™ncias visuais dos testes Playwright."
          echo ""
          echo "REGRA: Todos os testes ML-01 a ML-08 da Biblioteca de M√≠dia devem passar."
          echo ""
          echo "Para corrigir:"
          echo "  1. Execute: npx playwright test --config=playwright.media-vercel.config.ts"
          echo "  2. Verifique os screenshots em test-results/media-mcp/"
          echo "  3. Corrija os erros e fa√ßa push"
          echo ""
          cat test-output.txt || true
          exit 1
